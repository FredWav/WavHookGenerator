<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Historique & Favoris – PRO++</title>
  <style>
    :root{ --cream:#F7F3EE; --card:#FFFFFF; --ink:#111827; --muted:#6B7280;
      --blue:#61A8FF; --blue-strong:#3E8FFF; --border:#E5E7EB; --shadow:0 10px 30px rgba(0,0,0,.08); --radius:18px;
      --good:#16a34a; --mid:#f59e0b; --bad:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--cream);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    header{max-width:1100px;margin:20px auto 8px;padding:0 16px;display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:clamp(20px,2.4vw,30px)}
    nav a{color:var(--ink);text-decoration:none;border:1px solid var(--border);padding:8px 12px;border-radius:999px;background:#fff}
    .wrap{max-width:1100px;margin:0 auto 40px;padding:0 16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .inner{padding:18px}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="text"],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#FAFAFA}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#fff;color:#374151;margin-right:6px}
    .btn{border:0;padding:8px 12px;border-radius:10px;background:#fff;border:1px solid var(--border);cursor:pointer}
    .btn.primary{background:#61A8FF;color:#fff;border-color:#61A8FF}
    .score{font-weight:700}
    .muted{color:#6B7280}
    .hook{padding:8px;border:1px solid var(--border);border-radius:10px;background:#FCFCFD;margin-bottom:8px}
  </style>
</head>
<body>
  <header>
    <h1>Historique & Favoris</h1>
    <nav>
      <a href="index.html">← Retour générateur</a>
    </nav>
  </header>

  <section class="wrap">
    <div class="card">
      <div class="inner">
        <div class="row">
          <input id="q" type="text" placeholder="Rechercher par niche, thème, plateforme, hook…"/>
          <button class="btn" id="exportCSV">Exporter CSV</button>
          <button class="btn" id="exportTXT">Exporter TXT</button>
          <button class="btn" id="clear">Vider l'historique</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="inner" id="list"></div>
    </div>
  </section>

  <script>
    const KEY = 'hgpp_history_v1';

    function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY) || '[]'); }catch{ return []; } }
    function saveHistory(list){ try{ localStorage.setItem(KEY, JSON.stringify(list)); }catch{} }

    function search(list, q){
      if (!q) return list;
      q = q.toLowerCase();
      return list.filter(e => (
        (e.niche||'').toLowerCase().includes(q) ||
        (e.theme||'').toLowerCase().includes(q) ||
        (e.platform||'').toLowerCase().includes(q) ||
        (e.brief||'').toLowerCase().includes(q) ||
        (e.hooks||[]).some(h => (h.text||'').toLowerCase().includes(q))
      ));
    }

    function render(){
      const root = document.getElementById('list');
      const q = document.getElementById('q').value.trim();
      const data = search(loadHistory(), q);

      if (!data.length){ root.innerHTML = '<div class="muted">Aucun enregistrement.</div>'; return; }

      root.innerHTML = data.map(e => {
        const best = (e.hooks||[]).reduce((a,b)=> a.score>=b.score?a:b, {score:0, grade:'F'});
        const favCount = (e.hooks||[]).filter(h=>h.fav).length;
        const perf = e.performance ? `• ER: ${(e.performance.er||0).toFixed(2)}%` : '';
        return `
          <div class="entry" data-id="${e.id}" style="margin-bottom:16px">
            <div class="row" style="justify-content:space-between">
              <div>
                <span class="pill">${e.platform||''}</span>
                <span class="pill">${e.tone||''}</span>
                ${(e.categories||[]).map(c=>`<span class="pill">${c}</span>`).join('')}
              </div>
              <div class="muted">${new Date(e.ts).toLocaleString()}</div>
            </div>
            <div style="margin:6px 0"><b>${e.video?.title || e.theme}</b> — <span class="muted">${e.niche}</span></div>
            ${e.video?.link ? `<div><a href="${e.video.link}" target="_blank">${e.video.link}</a></div>` : ''}
            <div class="row" style="margin:6px 0">
              <span class="pill">Best: ${best.grade} (${best.score}/100)</span>
              <span class="pill">Hooks: ${e.count}</span>
              <span class="pill">Favoris: ${favCount}</span>
              ${e.performance ? `<span class="pill">Résultats ${perf}</span>` : ''}
            </div>
            <div class="muted">${e.brief || ''}</div>
            <div style="margin-top:8px">
              ${(e.hooks||[]).slice(0,3).map(h=>`<div class="hook"><b>${h.grade}</b> ${h.text}</div>`).join('')}
            </div>
            <div class="row" style="margin-top:8px">
              <button class="btn primary" onclick="reuse('${e.id}')">Réutiliser ce brief</button>
              <button class="btn" onclick="details('${e.id}')">Détails & performances</button>
              <button class="btn" onclick="del('${e.id}')">Supprimer</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function reuse(id){
      const e = loadHistory().find(x=>x.id===id);
      if (!e) return;
      const resume = {
        platform: e.platform, niche: e.niche, theme: e.theme, tone: e.tone,
        audience: e.audience, brief: e.brief, count: e.count,
        categories: e.categories, intensity: e.intensity
      };
      localStorage.setItem('hgpp_resume', JSON.stringify(resume));
      window.location.href = 'index.html';
    }

    function details(id){
      const list = loadHistory();
      const e = list.find(x=>x.id===id);
      if (!e) return;
      const hooks = e.hooks.map((h,i)=>`${i+1}. [${h.grade} ${h.score}/100] ${h.text}`).join('\n');
      const perf = e.performance ? `\n\nRésultats:\n- Vues: ${e.performance.views}\n- Likes: ${e.performance.likes}\n- Comms: ${e.performance.comments}\n- Partages: ${e.performance.shares}\n- Enregs: ${e.performance.saves}\n- ER: ${e.performance.er?.toFixed(2)}%\n` : '\n\nRésultats: (non renseignés)';
      alert(
        `Brief: ${e.niche} | ${e.theme} | ${e.tone}\nPlatforme: ${e.platform}\nLien: ${e.video?.link || '-'}\n\nHooks:\n${hooks}${perf}\nAstuce: clique “Détails & performances” de nouveau pour saisir les résultats.`
      );
      // Prompt simple pour saisir/maj performances
      const edit = confirm("Saisir/mettre à jour les résultats maintenant ?");
      if (edit){
        const views = parseInt(prompt("Vues :", e.performance?.views || 0) || 0, 10);
        const likes = parseInt(prompt("Likes :", e.performance?.likes || 0) || 0, 10);
        const comments = parseInt(prompt("Commentaires :", e.performance?.comments || 0) || 0, 10);
        const shares = parseInt(prompt("Partages :", e.performance?.shares || 0) || 0, 10);
        const saves = parseInt(prompt("Enregistrements :", e.performance?.saves || 0) || 0, 10);
        const er = views>0 ? ((likes+comments+shares+saves)/views)*100 : 0;
        e.performance = { views, likes, comments, shares, saves, er };
        saveHistory(list);
        render();
      }
    }

    function del(id){
      const list = loadHistory().filter(x=>x.id!==id);
      saveHistory(list);
      render();
    }

    function toCSV(rows){
      const esc = (s)=>(''+s).replace(/"/g,'""');
      const header = ["id","date","platform","niche","theme","tone","audience","brief","intensity","categories","count","video_title","video_link","hook_grade","hook_score","hook_text","er"];
      const lines = [header.join(",")];
      rows.forEach(e=>{
        (e.hooks||[]).forEach(h=>{
          lines.push([
            e.id, new Date(e.ts).toLocaleString(), e.platform, e.niche, e.theme, e.tone, e.audience||'', (e.brief||'').slice(0,200),
            e.intensity, (e.categories||[]).join('|'), e.count, e.video?.title||'', e.video?.link||'',
            h.grade, h.score, esc(h.text), e.performance?.er?.toFixed(2) || ''
          ].map(x=>`"${esc(x)}"`).join(","));
        });
      });
      return lines.join("\n");
    }
    function toTXT(rows){
      const out = [];
      rows.forEach(e=>{
        out.push(`=== ${new Date(e.ts).toLocaleString()} — ${e.platform} — ${e.niche} | ${e.theme}`);
        out.push(`Ton: ${e.tone} | Catégories: ${(e.categories||[]).join(', ')} | Intensité: ${e.intensity}`);
        if (e.video?.title) out.push(`Vidéo: ${e.video.title} (${e.video.link||''})`);
        if (e.brief) out.push(`Brief: ${e.brief}`);
        (e.hooks||[]).forEach((h,i)=> out.push(`${i+1}. [${h.grade} ${h.score}/100] ${h.text}`));
        if (e.performance){
          out.push(`Résultats: Vues ${e.performance.views}, Likes ${e.performance.likes}, Comms ${e.performance.comments}, Partages ${e.performance.shares}, Enregs ${e.performance.saves}, ER ${e.performance.er?.toFixed(2)}%`);
        }
        out.push("");
      });
      return out.join("\n");
    }

    function download(filename, content, mime='text/plain'){
      const blob = new Blob([content], {type:mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 500);
    }

    document.getElementById('exportCSV').onclick = ()=>{
      const data = loadHistory();
      download('hooks_history.csv', toCSV(data), 'text/csv');
    };
    document.getElementById('exportTXT').onclick = ()=>{
      const data = loadHistory();
      download('hooks_history.txt', toTXT(data), 'text/plain');
    };
    document.getElementById('clear').onclick = ()=>{
      if (confirm("Supprimer tout l'historique ?")) {
        localStorage.removeItem(KEY);
        render();
      }
    };
    document.getElementById('q').oninput = render;

    render();
  </script>
</body>
</html>
